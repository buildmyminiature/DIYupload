<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Frame Tool</title>
  <style>
    body { margin:0; padding:0; background:#f8f9fa; }
    #preview { margin:10px auto; max-width:500px; background:white; border:1px solid #ddd; border-radius:8px; overflow:hidden; }
    canvas { width:100%; height:auto; display:block; cursor:move; touch-action:none; }
    .btn { background:#4a90e2; color:white; padding:10px 20px; border:none; border-radius:50px; cursor:pointer; font-size:1em; display:block; margin:15px auto; }
    .download-btn { background:#8B4513; }
    #photo-list { margin:10px auto; display:flex; flex-wrap:wrap; justify-content:center; gap:10px; }
    .photo-thumb-container { position:relative; }
    .photo-thumb { width:60px; height:60px; object-fit:cover; border:2px solid #ddd; border-radius:6px; cursor:pointer; }
    .photo-thumb.active { border-color:#4a90e2; }
    .delete-btn { position:absolute; top:-6px; right:-6px; background:#ff4d4d; color:white; border:none; border-radius:50%; width:18px; height:18px; font-size:10px; cursor:pointer; }
  </style>
</head>
<body>

  <label for="upload" class="btn">Add Photo</label>
  <input type="file" id="upload" accept="image/*">

  <div id="preview">
    <canvas id="canvas" width="500" height="600"></canvas>
  </div>

  <div id="photo-list"></div>

  <button class="btn download-btn" onclick="downloadPNG()">Download</button>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const frameImg = new Image();
    frameImg.src = 'frame.png';

    let photos = [];
    let activePhotoIndex = -1;
    let isDragging = false;
    let startX, startY;
    let touchDist = 0;

    frameImg.onload = drawAll;

    function drawAll() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      photos.forEach(p => {
        ctx.drawImage(p.img, p.x, p.y, p.img.width * p.scale, p.img.height * p.scale);
      });
      ctx.drawImage(frameImg, 0, 0, canvas.width, canvas.height);
      if (activePhotoIndex >= 0) {
        const p = photos ;
        ctx.strokeStyle = 'rgba(74,144,226,0.9)';
        ctx.lineWidth = 6;
        ctx.strokeRect(p.x-3, p.y-3, p.img.width*p.scale+6, p.img.height*p.scale+6);
      }
    }

    document.getElementById('upload').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        const img = new Image();
        img.src = ev.target.result;
        img.onload = () => {
          const hole = {l:80, t:100, w:340, h:340};
          const s = Math.min(hole.w/img.width, hole.h/img.height) * 0.7;
          photos.push({img, x:hole.l+(hole.w-img.width*s)/2, y:hole.t+(hole.h-img.height*s)/2, scale:s});
          updatePhotoList();
          activePhotoIndex = photos.length-1;
          drawAll();
        };
      };
      reader.readAsDataURL(file);
    });

    function updatePhotoList() {
      const list = document.getElementById('photo-list');
      list.innerHTML = '';
      photos.forEach((p,i) => {
        const div = document.createElement('div');
        div.className = 'photo-thumb-container';
        const thumb = document.createElement('img');
        thumb.src = p.img.src;
        thumb.className = 'photo-thumb' + (i===activePhotoIndex?' active':'');
        thumb.onclick = () => {activePhotoIndex=i; updatePhotoList(); drawAll();};
        const del = document.createElement('button');
        del.className = 'delete-btn';
        del.textContent = 'X';
        del.onclick = ev => {ev.stopPropagation(); if(confirm('Delete?')){photos.splice(i,1); if(activePhotoIndex===i)activePhotoIndex=-1; updatePhotoList(); drawAll();}};
        div.appendChild(thumb); div.appendChild(del); list.appendChild(div);
      });
    }

    // Touch & mouse events (same as before, shortened)
    canvas.addEventListener('touchstart', e => {e.preventDefault(); if(activePhotoIndex<0)return;
      if(e.touches.length===1){isDragging=true; startX=e.touches[0].clientX-photos .x; startY=e.touches[0].clientY-photos .y;}
      else if(e.touches.length===2){const dx=e.touches[0 1].clientX, dy=e.touches[0 1].clientY; touchDist=Math.hypot(dx,dy);}
    });
    canvas.addEventListener('touchmove', e => {e.preventDefault(); if(activePhotoIndex<0)return;
      if(e.touches.length===1&&isDragging){photos .x=e.touches[0 0].clientY-startY; drawAll();}
      else if(e.touches.length===2){const dx=e.touches[0 1 0].clientY-e.touches[1].clientY, d=Math.hypot(dx,dy);
        if(touchDist>5){let z=d/touchDist; z=1+(z-1)*0.45; photos .scale*=z; photos .scale=Math.max(0.01,Math.min(photos .scale,8));}
        touchDist=d; drawAll();}
    });
    canvas.addEventListener('touchend', ()=>{isDragging=false;});
    canvas.addEventListener('mousedown', e=>{if(activePhotoIndex<0)return; isDragging=true; startX=e.offsetX-photos .x; startY=e.offsetY-photos .y; canvas.style.cursor='grabbing';});
    canvas.addEventListener('mousemove', e=>{if(!isDragging||activePhotoIndex<0)return; photos .x=e.offsetX-startX; photos .y=e.offsetY-startY; drawAll();});
    canvas.addEventListener('mouseup', ()=>{isDragging=false; canvas.style.cursor='move';});
    canvas.addEventListener('mouseleave', ()=>{isDragging=false; canvas.style.cursor='move';});
    canvas.addEventListener('wheel', e=>{e.preventDefault(); if(activePhotoIndex<0)return; let z=e.deltaY<0?1.1:0.9; photos .scale*=z; photos .scale=Math.max(0.01,Math.min(photos .scale,8)); drawAll();});

    function downloadPNG() {
      const temp = document.createElement('canvas');
      temp.width = canvas.width*2; temp.height = canvas.height*2;
      const tctx = temp.getContext('2d');
      tctx.scale(2,2);
      photos.forEach(p => tctx.drawImage(p.img, p.x, p.y, p.img.width*p.scale, p.img.height*p.scale));
      tctx.drawImage(frameImg, 0, 0, canvas.width, canvas.height);
      const a = document.createElement('a');
      a.href = temp.toDataURL('image/png');
      a.download = 'frame.png';
      a.click();
    }
  </script>
</body>
</html>
